# 03. ネットワークサービス

## 1. VPC (Amazon Virtual Private Cloud)

---

AWSのサービスであるEC2を世界中の顧客が各自が使用しているインスタンスなどのリソースに対して境界がなく、リソース間でネットワークを流れるトラフィックが制限なく発生してしまう。このような状況は「AWSリソースに対する境界を確立」すれば良い。AWSリソースに対する境界を確立するために使用できるネットワークサービスがAmazon VPCである。

「AWSリソースに対する境界を確立する」を言い換えれば、AWSクラウド内にプライベートなネットワーク環境を構築することができるとも言えるだろう。VPCを使用することでクラウド内に独立したセクションをプロビジョニングできる。VPCの内では、リソースをサブネットに整理できる。サブネットは、VPCの一部分であり、Amazon EC2インスタンスなどのリソースをその中に配置することが可能である。

インターネットからパブリックトラフィックをVPCに渡すためには、インターネットゲートウェイをVPCに付着させる。そうすると、このインターネットゲートウェイはVPCとインターネットに接続する。コーヒーショップのお客様が店内に入る際に使用するドアのようなものであり、これがない場合はVPC内のリソースには誰もアクセスできない。

![Untitled](03%20%E3%83%8D%E3%83%83%E3%83%88%E3%83%AF%E3%83%BC%E3%82%AF%E3%82%B5%E3%83%BC%E3%83%92%E3%82%99%E3%82%B9%2083b4d37e85874d7491914406fc391742/Untitled.png)

AWS Cloud Practitioner Essentials (Japanese) 説明参照

### VPCにプライベートリソースのみが含まれている場合はどうするか。

---

VPC内のプライベートリソースにアクセスするためには、仮想プライベートゲートウェイを使用する。

仮想プライベートゲートウェイの仕組みを、例を挙げて説明します。インターネットは、自宅とコーヒーショップの間の道路のようです。あなたは、ボディーガードに警護されながらこの道路を移動しているとします。他のお客様と同じ道路を利用してはいますが、保護は強化されています。

ボディーガードは、周辺の他のリクエストすべてに対し、あなたのインターネットトラフィックを暗号化 (または保護) する仮想プライベートネットワーク (VPN) 接続のようなものです。

仮想プライベートゲートウェイは、保護されたインターネットトラフィックを VPC で受け付けるようにするためのコンポーネントです。コーヒーショップに行くまでの道中、あなたは特別に警護されてはいますが、他のお客様と同じ道路を利用しているため、渋滞が発生する可能性があります。

仮想プライベートゲートウェイを使用すると、VPC とプライベートネットワーク (オンプレミスのデータセンターや社内ネットワークなど) の間に仮想プライベートネットワーク (VPN) 接続を確立できます。仮想プライベートゲートウェイでは、VPC へのトラフィックが許可されるのは、承認されたネットワークからのトラフィックのみです。

![Untitled](03%20%E3%83%8D%E3%83%83%E3%83%88%E3%83%AF%E3%83%BC%E3%82%AF%E3%82%B5%E3%83%BC%E3%83%92%E3%82%99%E3%82%B9%2083b4d37e85874d7491914406fc391742/Untitled%201.png)

AWS Cloud Practitioner Essentials (Japanese) 説明参照

### AWS Direct Connect

---

**[AWS Direct Connect](https://aws.amazon.com/directconnect/)** は、データセンターと VPC の間に専用のプライベート接続を確立できるサービスです。コーヒーショップ直結の通路があるアパートがあるとします。この通路を利用できるのはアパートの住人のみです。この専用通路によって、AWS Direct Connect と同様のタイプの専用接続が提供されます。住人は、他のお客様も移動する公道を利用せずに、コーヒーショップに入ることができます。AWS Direct Connect で確立できるプライベート接続によって、ネットワークコストを削減したり、ネットワークを通る帯域幅を増やしたりできます。

![Untitled](03%20%E3%83%8D%E3%83%83%E3%83%88%E3%83%AF%E3%83%BC%E3%82%AF%E3%82%B5%E3%83%BC%E3%83%92%E3%82%99%E3%82%B9%2083b4d37e85874d7491914406fc391742/Untitled%202.png)

AWS Cloud Practitioner Essentials (Japanese) 説明参照

## 2. サブネットとネットワークアクセスコントロールリスト

---

VPCを設定したアドレス範囲をサブネットに分けて定義します。サブネットは作成する時にAZとIPアドレス範囲を定義します。IPアドレス範囲はVPCで定義した範囲内で定義する必要があり、同一VPC内の他のサブネットと重複してはいけません。

コーヒーショップの例を使って、VPC 内のサブネットの役割について詳しく見ていきましょう。

まず、お客様はレジ係に注文します。レジ係はバリスタに注文内容を伝えます。このプロセスにより、さらに多くのお客様がやって来ても、注文の列をスムーズに処理し続けることができます。

一部のお客様は、レジ係にではなく、バリスタに直接注文しようとする場合があります。そうすると、注文処理の流れが中断され、本来制限されているコーヒーショップの内部へお客様がアクセスできるようになってしまいます。この状況を改善するために、コーヒーショップのオーナーは、レジ係とバリスタを別々の持ち場に配置してカウンターを分けます。レジ係の持ち場は、お客様に対応するために公開された場所にあります。バリスタの持ち場はプライベートエリアになっています。バリスタはレジ係からの注文を受け付けますが、お客様から直接注文を受けることはできません。これは、AWS ネットワークサービスを使用してリソースを分離し、ネットワークトラフィックの流れを正確に判別する方法と似ています。

コーヒーショップでは、カウンターを VPC と同じように考えることができます。カウンターは、レジ係の持ち場とバリスタの持ち場の 2 つのエリアにそれぞれ分かれています。VPC では、**サブネット**はリソースをグループ化するために使用する個別の領域です。

サブネットは、セキュリティまたは運用のニーズに基づいてリソースをグループ化できる VPC 内のセクションです。サブネットはパブリックに設定することも、プライベートに設定することもできます。

![Untitled](03%20%E3%83%8D%E3%83%83%E3%83%88%E3%83%AF%E3%83%BC%E3%82%AF%E3%82%B5%E3%83%BC%E3%83%92%E3%82%99%E3%82%B9%2083b4d37e85874d7491914406fc391742/Untitled%203.png)

AWS Cloud Practitioner Essentials (Japanese) 説明参照

**パブリックサブネット**には、オンラインストアのウェブサイトなど、一般公開されているリソースが含まれています。

**プライベートサブネット**には、お客様の個人情報や注文履歴を含むデータベースなど、プライベートネットワークを介してのみアクセス可能なリソースが含まれています。

VPC では、サブネットは相互に通信できます。例えば、パブリックサブネットにある Amazon EC2 インスタンスを含むアプリケーションからプライベートサブネットにあるデータベースに通信できます。

## 3. **VPC 内のネットワークトラフィック**

---

お客様が AWS クラウドでホストされているアプリケーションからデータをリクエストすると、このリクエストはパケットとして送信されます。**パケット**は、インターネットまたはネットワークを介して送信されるデータの単位です。

パケットは、インターネットゲートウェイを介して VPC に送信されます。パケットがサブネットに出入りする前に、アクセス許可がチェックされます。このアクセス許可には、パケットの送信者、パケットからサブネット内のリソースへの通信方法が示されています。

パケットからサブネットへのアクセス許可をチェックする VPC コンポーネントは、**[ネットワークアクセスコントロールリスト (ACL)](https://docs.aws.amazon.com/vpc/latest/userguide/vpc-network-acls.html)** です。

## 4. **ネットワークアクセスコントロールリスト (ACL)**

---

ネットワークアクセスコントロールリスト (ACL) は、サブネットレベルでインバウンドトラフィックとアウトバウンドトラフィックを制御する仮想ファイアウォールです。

例えば、あなたはコーヒーショップを離れて、空港にいるとします。空港では、旅行者が外国に行こうとしています。旅行者はパケット、入国審査官はネットワーク ACL と同じように考えることができます。入国審査官は、旅行者の出入国時にその旅行者の履歴情報を確認します。旅行者が承認リストに載っている場合、旅行者は入国できます。ただし、旅行者が承認リストに載っていない場合、または入国禁止者のリストに明示的に載っている場合は、入国できません。

各 AWS アカウントには、デフォルトのネットワーク ACL があります。VPC を設定する際は、アカウントのデフォルトのネットワーク ACL を使用するか、カスタムネットワーク ACL を作成できます。

デフォルトでは、アカウントのデフォルトのネットワーク ACL は、すべてのインバウンドトラフィックとアウトバウンドトラフィックを許可します。独自のルールを追加して、この設定を変更することもできます。カスタムネットワーク ACL の場合、許可するトラフィックを指定するルールを追加するまでは、すべてのインバウンドトラフィックとアウトバウンドトラフィックが拒否されます。さらに、すべてのネットワーク ACL には、明示的な拒否ルールがあります。このルールによって、パケットがリストの他のいずれのルールにも一致しない場合は、確実に拒否されます。

## 5. **ステートレスパケットフィルタリング**

---

![Untitled](03%20%E3%83%8D%E3%83%83%E3%83%88%E3%83%AF%E3%83%BC%E3%82%AF%E3%82%B5%E3%83%BC%E3%83%92%E3%82%99%E3%82%B9%2083b4d37e85874d7491914406fc391742/Untitled%204.png)

ネットワーク ACL では、**ステートレス**パケットフィルタリングが実行されます。処理情報が保存されないため、パケットはサブネットの境界 (インバウンドとアウトバウンドの双方向) を出入りするたびにチェックされます。

先ほど取り上げた、外国に行こうとする旅行者の例を思い出してください。これは、Amazon EC2 インスタンスからインターネットにリクエストを送信するのと似ています。

リクエストに対するレスポンスが返ってくるとき、ネットワーク ACL に以前のリクエストの情報は保存されていません。ネットワーク ACL では、パケットの応答がルールのリストと照合され、許可するか拒否するかが決定されます。

## 6. **ステートレスパケットフィルタリング**

---

ネットワーク ACL では、**ステートレス**パケットフィルタリングが実行されます。処理情報が保存されないため、パケットはサブネットの境界 (インバウンドとアウトバウンドの双方向) を出入りするたびにチェックされます。

先ほど取り上げた、外国に行こうとする旅行者の例を思い出してください。これは、Amazon EC2 インスタンスからインターネットにリクエストを送信するのと似ています。

リクエストに対するレスポンスが返ってくるとき、ネットワーク ACL に以前のリクエストの情報は保存されていません。ネットワーク ACL では、パケットの応答がルールのリストと照合され、許可するか拒否するかが決定されます。パケットがサブネットを通過したら、次はサブネット内のリソース (Amazon EC2 インスタンスなど) に対して評価するアクセス許可が必要です。

パケットの Amazon EC2 インスタンスへのアクセス許可をチェックする VPC コンポーネントは、**[セキュリティグループ](https://docs.aws.amazon.com/vpc/latest/userguide/VPC_SecurityGroups.html)**です。

## 7. **セキュリティグループ**

---

セキュリティグループは、Amazon EC2 インスタンスのインバウンドトラフィックとアウトバウンドトラフィックを制御する仮想ファイアウォールです。

デフォルトでは、セキュリティグループはすべてのインバウンドトラフィックを拒否し、すべてのアウトバウンドトラフィックを許可します。ユーザーはカスタムルールを追加して、許可または拒否するトラフィックを設定できます。

例えば、あるアパートには、ロビーで来客を迎えるドアスタッフがいるとします。来客はパケット、ドアスタッフはセキュリティグループと同じように考えることができます。来客が到着すると、ドアスタッフはリストをチェックし、その来客がアパートに入ることができるかを確認します。ただし、来客がアパートを出る際、ドアスタッフがリストを再度チェックすることはありません。

サブネット内に Amazon EC2 インスタンスが複数ある場合は、インスタンスを同じセキュリティグループに関連付けることも、インスタンスごとに異なるセキュリティグループを使用することもできます。

## 8. **ステートフルパケットフィルタリング**

---

セキュリティグループでは、**ステートフル**パケットフィルタリングが実行されます。受信パケットに対して行われた以前の処理情報は保存されています。

Amazon EC2 インスタンスからインターネットにリクエストを送信するという先ほどの例をもう一度考えます。

そのリクエストに対するレスポンスがインスタンスに返されるとき、以前のリクエストの情報がセキュリティグループに保存されています。この場合、セキュリティグループは、セキュリティグループのインバウンドルールに関係なく、レスポンスの通信を通過させます。

ネットワーク ACL とセキュリティグループのいずれにおいても、VPC 内のトラフィックにカスタムルールを設定できます。AWS のセキュリティとネットワークについてさらに学習する際は、ネットワーク ACL とセキュリティグループの違いを必ず理解するようにしてください。